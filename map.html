<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIFF è¶…å¼·åœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f0f0; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* é ‚éƒ¨ï¼šè·é›¢é¡¯ç¤ºæ¢ */
        #distance-bar {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.8); color: #fff;
            padding: 10px; border-radius: 30px;
            text-align: center; font-weight: bold; font-size: 1.1rem;
            z-index: 1000; display: none; /* é è¨­éš±è—ï¼Œæœ‰æ——å­æ‰é¡¯ç¤º */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        #distance-bar span { color: #00ffea; }

        /* åº•éƒ¨ï¼šæ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 15px 20px 30px 20px; z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        /* ç‹€æ…‹æŒ‰éˆ•åˆ— (æ©«å‘æ²å‹•) */
        .status-scroll {
            display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }
        .status-btn {
            background: #f1f3f5; border: 1px solid #ddd; border-radius: 20px;
            padding: 8px 16px; font-size: 0.9rem; color: #333; white-space: nowrap; cursor: pointer;
        }
        .status-btn:active { background: #e9ecef; transform: scale(0.95); }

        /* ä¸»è¦æŒ‰éˆ•å€ */
        .main-actions { display: flex; gap: 10px; }
        .action-btn {
            flex: 1; padding: 12px; border: none; border-radius: 10px;
            font-size: 1rem; font-weight: bold; cursor: pointer; color: white;
        }
        #btnFlag { background-color: #ff9800; } /* æ©˜è‰² */
        #btnShare { background-color: #06c755; } /* LINE ç¶  */
        #btnConnect { background-color: #007bff; width: 100%; }

        /* ç™»å…¥è¡¨å–® */
        #login-form { text-align: center; margin-bottom: 10px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        /* ç³»çµ±é€šçŸ¥ */
        #system-msg {
            position: absolute; bottom: 200px; left: 20px; right: 20px;
            z-index: 2000; background-color: rgba(0,0,0,0.7); color: white;
            padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem;
            display: none; pointer-events: none;
        }
        
        /* æ°£æ³¡æ¨£å¼ */
        .leaflet-tooltip.status-bubble {
            background-color: white; border: 2px solid #333; color: black; font-weight: bold;
            font-size: 14px; padding: 5px 10px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .leaflet-tooltip-bottom:before { border-bottom-color: #333; }
    </style>
</head>
<body>

    <div id="distance-bar">ğŸ è·é›¢é›†åˆé»ï¼š<span id="dist-val">è¨ˆç®—ä¸­...</span></div>

    <div id="system-msg"></div>

    <div id="controls">
        <div id="login-form">
            <h3>ğŸ“ å³æ™‚é›†åˆåœ°åœ–</h3>
            <input type="text" id="roomId" value="room1" placeholder="è¼¸å…¥æˆ¿è™Ÿ" oninput="this.value = this.value.toLowerCase()">
            <button id="btnConnect" class="action-btn" onclick="connect()">ğŸš€ å•Ÿå‹•å®šä½ä¸¦åŠ å…¥</button>
        </div>

        <div id="active-panel" style="display: none;">
            <div class="status-scroll">
                <button class="status-btn" onclick="sendStatus('ğŸƒ å¿«åˆ°äº†')">ğŸƒ å¿«åˆ°äº†</button>
                <button class="status-btn" onclick="sendStatus('ğŸ¢ å¡è»Šä¸­')">ğŸ¢ å¡è»Šä¸­</button>
                <button class="status-btn" onclick="sendStatus('ğŸ¤” è¿·è·¯äº†')">ğŸ¤” è¿·è·¯äº†</button>
                <button class="status-btn" onclick="sendStatus('ğŸš½ æ‰¾å»æ‰€')">ğŸš½ æ‰¾å»æ‰€</button>
                <button class="status-btn" onclick="sendStatus('ğŸ…¿ï¸ æ‰¾è»Šä½')">ğŸ…¿ï¸ æ‰¾è»Šä½</button>
            </div>

            <div class="main-actions">
                <button id="btnFlag" class="action-btn" onclick="toggleFlagMode()">ğŸš© è¨­å®šé›†åˆé»</button>
                <button id="btnShare" class="action-btn" onclick="shareToFriends()">ğŸ“¤ é‚€è«‹æœ‹å‹</button>
            </div>
            <div style="text-align:center; margin-top:10px; font-size:0.8rem; color:#888;">
                <span id="status-text">é€£ç·šä¸­...</span> 
                | <a href="#" onclick="disconnect()" style="color:#dc3545; text-decoration:none;">é›¢é–‹</a>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        // è¨­å®šå€
        const LIFF_ID = "2008736917-XphF2Hry"; // æ‚¨çš„ LIFF ID
        
        // åœ°åœ–åˆå§‹åŒ–
        const map = L.map('map', { zoomControl: false }).setView([25.0330, 121.5654], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // è®Šæ•¸
        let ws = null;
        let myMarker = null;
        let flagMarker = null; // é›†åˆé»æ¨™è¨˜
        const otherMarkers = {};
        let myProfile = { name: "User", pictureUrl: "" };
        let myLat = null, myLng = null;
        let isFlagMode = false;
        let heartbeatInterval, reconnectTimeout;

        // 1. LIFF åˆå§‹åŒ–
        window.onload = async function() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                const profile = await liff.getProfile();
                myProfile.name = profile.displayName;
                myProfile.pictureUrl = profile.pictureUrl;

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('room')) document.getElementById('roomId').value = urlParams.get('room');

            } catch (err) {
                console.error(err);
                // å³ä½¿ LIFF å¤±æ•—ä¹Ÿå…è¨±æ¸¬è©¦
            }
        };

        // 2. é€£ç·šèˆ‡ä¸»è¦é‚è¼¯
        function connect() {
            const roomId = document.getElementById('roomId').value;
            if (!roomId) return alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");

            // åˆ‡æ›ä»‹é¢
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('active-panel').style.display = 'block';

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${roomId}`;
            
            try {
                ws = new WebSocket(wsUrl);
                ws.onopen = () => {
                    updateStatus("âœ… é€£ç·šæˆåŠŸ");
                    startTracking();
                    startHeartbeat();
                };
                ws.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    handleMessage(data);
                };
                ws.onclose = () => {
                    updateStatus("æ–·ç·šé‡é€£ä¸­...");
                    scheduleReconnect();
                };
            } catch(e) { console.error(e); }
        }

        function handleMessage(data) {
            if (data.type === 'location') {
                updateOtherMarker(data);
            } else if (data.type === 'flag') {
                // æ”¶åˆ°é›†åˆé»æ›´æ–°
                updateFlag(data.lat, data.lng, data.setter);
            } else if (data.type === 'status') {
                // æ”¶åˆ°ç‹€æ…‹æ°£æ³¡
                showStatusBubble(data.name, data.msg);
            } else if (data.type === 'system') {
                showSystemMsg(data.msg);
            }
        }

        // 3. é›†åˆé»åŠŸèƒ½ (Feature 1 & 3)
        function toggleFlagMode() {
            isFlagMode = !isFlagMode;
            const btn = document.getElementById('btnFlag');
            if (isFlagMode) {
                btn.innerText = "ğŸ“ è«‹é»æ“Šåœ°åœ–æ’æ——";
                btn.style.backgroundColor = "#dc3545"; // ç´…è‰²æç¤º
                showSystemMsg("è«‹é»æ“Šåœ°åœ–ä»»ä¸€è™•è¨­å®šé›†åˆé»");
            } else {
                btn.innerText = "ğŸš© è¨­å®šé›†åˆé»";
                btn.style.backgroundColor = "#ff9800";
            }
        }

        // é»æ“Šåœ°åœ–äº‹ä»¶
        map.on('click', function(e) {
            if (isFlagMode && ws) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // ç™¼é€ Flag äº‹ä»¶çµ¦ Server
                ws.send(JSON.stringify({
                    type: 'flag', lat: lat, lng: lng, setter: myProfile.name
                }));

                // é—œé–‰æ¨¡å¼
                toggleFlagMode();
            }
        });

        function updateFlag(lat, lng, setterName) {
            if (flagMarker) map.removeLayer(flagMarker);
            
            // å»ºç«‹æ——å­æ¨™è¨˜
            const flagIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="font-size:30px;">ğŸ</div>`,
                iconSize: [30, 30], iconAnchor: [15, 30]
            });
            
            flagMarker = L.marker([lat, lng], {icon: flagIcon}).addTo(map)
                .bindPopup(`<b>é›†åˆé»</b><br>ç”± ${setterName} è¨­å®š`).openPopup();
            
            showSystemMsg(`${setterName} æ›´æ–°äº†é›†åˆé»ï¼`);
            
            // é¡¯ç¤ºè·é›¢æ¢
            document.getElementById('distance-bar').style.display = 'block';
            calculateDistance(); // ç«‹å³è¨ˆç®—ä¸€æ¬¡
        }

        // è¨ˆç®—è·é›¢ (Feature 3)
        function calculateDistance() {
            if (!flagMarker || myLat === null) return;
            
            const from = L.latLng(myLat, myLng);
            const to = flagMarker.getLatLng();
            const meters = from.distanceTo(to); // Leaflet å…§å»ºè·é›¢è¨ˆç®— (å…¬å°º)
            
            let text = "";
            if (meters < 10) text = "å·²æŠµé”ï¼ğŸ‰";
            else if (meters < 1000) text = `${Math.round(meters)} å…¬å°º`;
            else text = `${(meters/1000).toFixed(1)} å…¬é‡Œ`;
            
            document.getElementById('dist-val').innerText = text;
        }

        // 4. ç‹€æ…‹æ°£æ³¡åŠŸèƒ½ (Feature 2)
        function sendStatus(msg) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'status', name: myProfile.name, msg: msg
                }));
                // è‡ªå·±ä¹Ÿè¦é¡¯ç¤º
                showStatusBubble(myProfile.name, msg); 
            }
        }

        function showStatusBubble(name, msg) {
            let targetMarker = (name === myProfile.name) ? myMarker : otherMarkers[name];
            
            if (targetMarker) {
                targetMarker.bindTooltip(msg, {
                    permanent: true, 
                    direction: 'top', 
                    className: 'status-bubble',
                    offset: [0, -20]
                }).openTooltip();

                // 5ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
                setTimeout(() => {
                    targetMarker.unbindTooltip();
                }, 5000);
            }
        }

        // 5. GPS è¿½è¹¤èˆ‡åŸºæœ¬åŠŸèƒ½
        function startTracking() {
            if (!navigator.geolocation) return;
            navigator.geolocation.watchPosition(
                (pos) => {
                    myLat = pos.coords.latitude;
                    myLng = pos.coords.longitude;
                    updateMyLocation(myLat, myLng);
                    calculateDistance(); // æ¯æ¬¡ç§»å‹•éƒ½é‡æ–°ç®—è·é›¢
                },
                err => console.error(err),
                { enableHighAccuracy: true }
            );
        }

        function updateMyLocation(lat, lng) {
            if (!myMarker) {
                const icon = L.divIcon({
                    html: `<div style="background-image:url('${myProfile.pictureUrl || 'https://via.placeholder.com/40'}');width:40px;height:40px;background-size:cover;border-radius:50%;border:3px solid #06c755;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`,
                    className: '', iconSize: [40, 40], iconAnchor: [20, 20]
                });
                myMarker = L.marker([lat, lng], {icon: icon}).addTo(map).bindPopup("æˆ‘");
                map.panTo([lat, lng]);
            } else {
                myMarker.setLatLng([lat, lng]);
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'location', lat: lat, lng: lng, name: myProfile.name, avatar: myProfile.pictureUrl
                }));
            }
        }

        function updateOtherMarker(data) {
            const { name, lat, lng, avatar } = data;
            if (otherMarkers[name]) {
                otherMarkers[name].setLatLng([lat, lng]);
            } else {
                const icon = L.divIcon({
                    html: `<div style="background-image:url('${avatar || 'https://via.placeholder.com/40'}');width:40px;height:40px;background-size:cover;border-radius:50%;border:3px solid #ff3333;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`,
                    className: '', iconSize: [40, 40], iconAnchor: [20, 20]
                });
                otherMarkers[name] = L.marker([lat, lng], {icon: icon}).addTo(map).bindPopup(name);
            }
        }

        // è¼”åŠ©åŠŸèƒ½
        function shareToFriends() {
            const url = `https://liff.line.me/${LIFF_ID}?room=${document.getElementById('roomId').value}`;
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([{
                    type: "flex", altText: "åŠ å…¥åœ°åœ–",
                    contents: { type: "bubble", body: { type: "box", layout: "vertical", contents: [
                        { type: "text", text: "ğŸ“ é»æ­¤åŠ å…¥å³æ™‚åœ°åœ–", weight: "bold", size: "lg", color: "#06c755" },
                        { type: "text", text: "æŸ¥çœ‹å¤§å®¶çš„ä½ç½®èˆ‡é›†åˆé»", size: "xs", color: "#aaaaaa" }
                    ] }, footer: { type: "box", layout: "vertical", contents: [{ type: "button", action: { type: "uri", label: "é–‹å•Ÿåœ°åœ–", uri: url } }] } }
                }]);
            } else {
                navigator.clipboard.writeText(url).then(() => alert("ç¶²å€å·²è¤‡è£½"));
            }
        }

        function disconnect() { if(ws) ws.close(); location.reload(); }
        function scheduleReconnect() { if(reconnectTimeout) clearTimeout(reconnectTimeout); reconnectTimeout = setTimeout(connect, 3000); }
        function startHeartbeat() { if(heartbeatInterval) clearInterval(heartbeatInterval); heartbeatInterval = setInterval(() => { if(ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({type:'ping'})); }, 30000); }
        function updateStatus(msg) { document.getElementById('status-text').innerText = msg; }
        function showSystemMsg(msg) { const el = document.getElementById('system-msg'); el.innerText = msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 3000); }
    </script>
</body>
</html>