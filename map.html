<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIFF å³æ™‚åœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f0f0; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* é ‚éƒ¨ï¼šè·é›¢é¡¯ç¤ºæ¢ */
        #distance-bar {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.8); color: #fff;
            padding: 10px; border-radius: 30px;
            text-align: center; font-weight: bold; font-size: 1.1rem;
            z-index: 1000; display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            pointer-events: none;
            transition: all 0.3s ease;
        }
        #distance-bar.arrived { background: rgba(6, 199, 85, 0.9); transform: scale(1.05); }
        #distance-bar span { color: #00ffea; }

        /* â˜… å³ä¸Šè§’åœ¨ç·šåå–® (å‡ç´šç‰ˆ) */
        #user-list-panel {
            position: absolute; top: 60px; right: 10px;
            background: rgba(0, 0, 0, 0.7); color: white;
            padding: 8px; border-radius: 12px;
            z-index: 999; backdrop-filter: blur(5px);
            max-height: 250px; overflow-y: auto;
            min-width: 130px;
            font-size: 0.85rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #user-list-panel h4 { 
            margin: 0 0 8px 0; font-size: 0.9rem; color: #00ffea; 
            border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        /* æ¸…å–®é …ç›®æ¨£å¼ */
        .user-list-item { 
            display: flex; align-items: center; gap: 8px; margin-bottom: 6px; 
            padding: 5px; border-radius: 8px; cursor: pointer;
            transition: background 0.2s;
        }
        .user-list-item:active { background: rgba(255,255,255,0.2); transform: scale(0.98); }
        
        /* é ­è²¼æ¨£å¼ */
        .user-list-avatar {
            width: 24px; height: 24px; border-radius: 50%; object-fit: cover;
            border: 1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* ç‹€æ…‹é» */
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #06c755; box-shadow: 0 0 4px #06c755;}
        .status-dot.offline { background: #999; box-shadow: none; }

        /* åº•éƒ¨ï¼šæ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 15px 20px 30px 20px; z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        /* ç‹€æ…‹æŒ‰éˆ•åˆ— */
        .status-scroll {
            display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }
        .status-btn {
            background: #f1f3f5; border: 1px solid #ddd; border-radius: 20px;
            padding: 8px 16px; font-size: 0.9rem; color: #333; white-space: nowrap; cursor: pointer;
        }
        .status-btn:active { background: #e9ecef; transform: scale(0.95); }

        /* ä¸»è¦æŒ‰éˆ•å€ */
        .main-actions { display: flex; gap: 10px; }
        .action-btn {
            flex: 1; padding: 12px; border: none; border-radius: 10px;
            font-size: 1rem; font-weight: bold; cursor: pointer; color: white;
        }
        #btnFlag { background-color: #ff9800; }
        #btnShare { background-color: #06c755; }
        #btnConnect { background-color: #007bff; width: 100%; }

        /* æµ®å‹•æŒ‰éˆ•ç¾¤çµ„ */
        .float-btn-group {
            position: absolute; bottom: 180px; right: 20px;
            display: flex; flex-direction: column; gap: 10px; z-index: 900;
        }
        .float-btn {
            width: 50px; height: 50px; background: white; border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; border: none;
        }
        #btnSensors.active { background-color: #00ffea; border: 2px solid #007bff; }
        #btnCenter.active { background-color: #ffdd00; border: 2px solid #ff9800; }

        /* ç™»å…¥è¡¨å–® */
        #login-form { text-align: center; margin-bottom: 10px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; text-align: center; color: #555; }

        /* ç³»çµ±é€šçŸ¥ */
        #system-msg {
            position: absolute; bottom: 250px; left: 20px; right: 20px;
            z-index: 2000; background-color: rgba(0,0,0,0.7); color: white;
            padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem;
            display: none; pointer-events: none;
        }
        
        /* æ°£æ³¡æ¨£å¼ */
        .leaflet-tooltip.status-bubble {
            background-color: white; border: 2px solid #333; color: black; font-weight: bold;
            font-size: 14px; padding: 5px 10px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .leaflet-tooltip-bottom:before { border-bottom-color: #333; }

        /* å¤±è¯è®Šç°æ¨£å¼ */
        .offline-marker {
            filter: grayscale(100%) opacity(0.5);
            transition: filter 0.5s ease;
        }

        /* æ–ä¸€æ–å‘¼å–šç‰¹æ•ˆ */
        @keyframes shake-flash {
            0% { box-shadow: inset 0 0 0 0 rgba(255, 0, 0, 0); }
            50% { box-shadow: inset 0 0 50px 20px rgba(255, 0, 0, 0.5); }
            100% { box-shadow: inset 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .shake-alert { animation: shake-flash 0.5s ease-in-out 3; }

        /* ä½¿ç”¨è€…æ¨™è¨˜å®¹å™¨ */
        .user-marker-container {
            position: relative; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
        }
        .user-avatar {
            width: 40px; height: 40px; background-size: cover; border-radius: 50%;
            border: 3px solid #06c755; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 2; position: relative;
        }
        .vision-cone {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 40px solid rgba(0, 255, 234, 0.5);
            border-radius: 50%; z-index: 1; transform-origin: bottom center;
            display: none; filter: blur(2px);
        }
        .motion-badge {
            position: absolute; bottom: -5px; right: -5px; width: 22px; height: 22px;
            background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); z-index: 3; border: 1px solid #ddd;
        }
        
        /* é›»æ± æ¢æ¨£å¼ */
        .battery-bar-container {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 30px; height: 6px; background: #333; border-radius: 3px;
            border: 1px solid #fff; z-index: 3; overflow: hidden;
        }
        .battery-level {
            height: 100%; background: #00ff00; width: 100%; transition: width 0.3s;
        }
        .charging-icon {
            position: absolute; top: -18px; right: -8px; font-size: 12px;
            color: yellow; text-shadow: 0 0 2px black; z-index: 4; display: none;
        }
    </style>
</head>
<body>

    <div id="distance-bar">ğŸ è·é›¢é›†åˆé»ï¼š<span id="dist-val">è¨ˆç®—ä¸­...</span></div>
    
    <div id="user-list-panel" style="display: none;">
        <h4>ğŸ‘¥ åœ¨ç·šåå–® (<span id="user-count">0</span>)</h4>
        <div id="user-list-content"></div>
    </div>

    <div id="system-msg"></div>

    <div class="float-btn-group" id="floatBtns" style="display: none;">
        <button class="float-btn" id="btnSensors" onclick="enableSensors()">ğŸ§­</button>
        <button class="float-btn" id="btnCenter" onclick="calculateGroupCenter()">âš–ï¸</button>
        <button class="float-btn" id="btnRecenter" onclick="centerMapOnMe()">ğŸ¯</button>
    </div>

    <div id="controls">
        <div id="login-form">
            <h3>ğŸ“ å³æ™‚é›†åˆåœ°åœ–</h3>
            <input type="text" id="roomId" placeholder="ç”¢ç”Ÿæˆ¿è™Ÿä¸­..." readonly style="background-color: #f9f9f9; border: none; font-weight: bold;">
            <button id="btnConnect" class="action-btn" onclick="connect()">ğŸš€ é€²å…¥æˆ¿é–“</button>
        </div>

        <div id="active-panel" style="display: none;">
            <div class="status-scroll">
                <button class="status-btn" onclick="sendStatus('ğŸƒ å¿«åˆ°äº†')">ğŸƒ å¿«åˆ°äº†</button>
                <button class="status-btn" onclick="sendStatus('ğŸ¢ å¡è»Šä¸­')">ğŸ¢ å¡è»Šä¸­</button>
                <button class="status-btn" onclick="sendStatus('ğŸ¤” è¿·è·¯äº†')">ğŸ¤” è¿·è·¯äº†</button>
                <button class="status-btn" onclick="sendStatus('ğŸš½ æ‰¾å»æ‰€')">ğŸš½ æ‰¾å»æ‰€</button>
                <button class="status-btn" onclick="sendStatus('ğŸ…¿ï¸ æ‰¾è»Šä½')">ğŸ…¿ï¸ æ‰¾è»Šä½</button>
            </div>

            <div class="main-actions">
                <button id="btnFlag" class="action-btn" onclick="toggleFlagMode()">ğŸš© è¨­å®šé›†åˆé»</button>
                <button id="btnShare" class="action-btn" onclick="shareToFriends()">ğŸ“¤ é‚€è«‹æœ‹å‹</button>
            </div>
            <div style="text-align:center; margin-top:10px; font-size:0.8rem; color:#888;">
                <span id="status-text">é€£ç·šä¸­...</span> 
                | <a href="#" onclick="disconnect()" style="color:#dc3545; text-decoration:none;">é›¢é–‹</a>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        const LIFF_ID = "2008736917-XphF2Hry"; // æ›¿æ›æ‚¨çš„ ID
        
        const map = L.map('map', { zoomControl: false }).setView([25.0330, 121.5654], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let ws = null;
        let myMarker = null;
        let flagMarker = null;
        let centerMarker = null;
        const otherMarkers = {}; // { marker, lastUpdate, history, polyline, avatar }
        let myHistory = []; 
        let myPolyline = null;

        let myProfile = { name: "User", pictureUrl: "" };
        let myLat = null, myLng = null;
        let isFlagMode = false;
        let hasArrived = false;
        let heartbeatInterval, reconnectTimeout, staleCheckInterval;
        let wakeLock = null;
        let sensorsEnabled = false;
        let lastShakeTime = 0;
        let batteryLevel = 100;
        let isCharging = false;

        window.onload = async function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                let currentRoom = urlParams.get('room');
                if (!currentRoom) {
                    currentRoom = Math.random().toString(36).substring(2, 8);
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('room', currentRoom);
                    window.history.replaceState(null, '', newUrl.toString());
                }
                document.getElementById('roomId').value = currentRoom;

                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                    return;
                }
                const profile = await liff.getProfile();
                myProfile.name = profile.displayName;
                myProfile.pictureUrl = profile.pictureUrl;
                
                initBattery();

            } catch (err) { console.error("LIFF Error", err); }
        };

        function connect() {
            const roomId = document.getElementById('roomId').value;
            if (!roomId) return alert("æˆ¿è™ŸéŒ¯èª¤");

            document.getElementById('login-form').style.display = 'none';
            document.getElementById('active-panel').style.display = 'block';
            document.getElementById('floatBtns').style.display = 'flex';
            document.getElementById('user-list-panel').style.display = 'block';

            requestWakeLock();

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${roomId}`;
            
            try {
                ws = new WebSocket(wsUrl);
                ws.onopen = () => {
                    updateStatus("âœ… é€£ç·šæˆåŠŸ");
                    startTracking();
                    startHeartbeat();
                    startStaleCheck();
                    updateUserListUI();
                };
                ws.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    handleMessage(data);
                };
                ws.onclose = () => {
                    updateStatus("æ–·ç·šé‡é€£ä¸­...");
                    scheduleReconnect();
                };
            } catch(e) { console.error(e); }
        }

        async function initBattery() {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    updateBatteryStatus(battery);
                    battery.addEventListener('levelchange', () => updateBatteryStatus(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryStatus(battery));
                } catch (e) { console.log("Battery API error", e); }
            }
        }
        function updateBatteryStatus(battery) {
            batteryLevel = Math.floor(battery.level * 100);
            isCharging = battery.charging;
        }

        function handleMessage(data) {
            if (data.type === 'location') {
                updateOtherMarker(data);
            } else if (data.type === 'flag') {
                updateFlag(data.lat, data.lng, data.setter);
            } else if (data.type === 'status') {
                showStatusBubble(data.name, data.msg);
            } else if (data.type === 'system') {
                showSystemMsg(data.msg);
            } else if (data.type === 'ping') {
                triggerShakeAlert(data.name);
            }
        }

        // â˜… åå–® UI æ›´æ–° (å«è·³è½‰åŠŸèƒ½)
        function updateUserListUI() {
            const listDiv = document.getElementById('user-list-content');
            const countSpan = document.getElementById('user-count');
            
            let users = [];
            // è‡ªå·±
            if (myProfile.name) {
                users.push({ 
                    name: myProfile.name + " (æˆ‘)", 
                    avatar: myProfile.pictureUrl, 
                    online: true,
                    isMe: true 
                });
            }
            // åˆ¥äºº
            const now = Date.now();
            for (const name in otherMarkers) {
                const u = otherMarkers[name];
                const isOnline = (now - u.lastUpdate) / 1000 < 30;
                users.push({ 
                    name: name, 
                    avatar: u.avatar, // å¾è³‡æ–™ä¸­è®€å–
                    online: isOnline,
                    isMe: false
                });
            }

            countSpan.innerText = users.length;
            listDiv.innerHTML = users.map(u => `
                <div class="user-list-item" onclick="jumpToUser('${u.name}', ${u.isMe})">
                    <img class="user-list-avatar" src="${u.avatar || 'https://via.placeholder.com/40'}" alt="">
                    <div class="status-dot ${u.online ? '' : 'offline'}"></div>
                    <span>${u.name}</span>
                </div>
            `).join('');
        }

        // â˜… è·³è½‰åŠŸèƒ½
        function jumpToUser(name, isMe) {
            if (isMe) {
                centerMapOnMe();
            } else {
                // å¾ name ç§»é™¤ " (æˆ‘)" ä»¥å¤–çš„éƒ¨åˆ†ï¼Œå…¶å¯¦å‚³é€²ä¾†çš„ name å·²ç¶“æ˜¯ key
                const target = otherMarkers[name];
                if (target && target.marker) {
                    map.flyTo(target.marker.getLatLng(), 17);
                    showSystemMsg(`ğŸ” å·²å®šä½åˆ° ${name}`);
                }
            }
        }

        function updateOtherMarker(data) {
            const { name, lat, lng, avatar, motion, battery, charging } = data;
            const now = Date.now();
            const motionIcon = motion || 'ğŸš¶';
            
            const batLevel = battery || 100;
            let batColor = '#00ff00';
            if (batLevel < 20) batColor = '#ff0000';
            else if (batLevel < 50) batColor = '#ffa500';
            const chargingDisplay = charging ? 'block' : 'none';

            if (!otherMarkers[name]) {
                const icon = L.divIcon({
                    html: `
                    <div class="user-marker-container">
                        <div class="battery-bar-container"><div class="battery-level" style="width:${batLevel}%; background:${batColor};"></div></div>
                        <div class="charging-icon" style="display:${chargingDisplay}">âš¡</div>
                        <div class="user-avatar" style="background-image:url('${avatar || 'https://via.placeholder.com/40'}'); border-color: #ff3333;"></div>
                        <div class="motion-badge">${motionIcon}</div>
                    </div>`,
                    className: '', iconSize: [40, 40], iconAnchor: [20, 20]
                });
                const marker = L.marker([lat, lng], {icon: icon}).addTo(map).bindPopup(name + ` (é›»é‡: ${batLevel}%)`);
                const polyline = L.polyline([], {color: 'red', weight: 3, opacity: 0.5, dashArray: '5, 10'}).addTo(map);

                // â˜… é€™è£¡å¤šå­˜ä¸€å€‹ avatar æ¬„ä½
                otherMarkers[name] = { marker: marker, lastUpdate: now, history: [[lat, lng]], polyline: polyline, avatar: avatar };
            } else {
                const user = otherMarkers[name];
                user.marker.setLatLng([lat, lng]);
                user.lastUpdate = now;
                user.avatar = avatar; // æ›´æ–°é ­åƒ (å¦‚æœæœ‰çš„è©±)
                
                const iconDiv = user.marker.getElement();
                if (iconDiv) {
                    iconDiv.classList.remove('offline-marker');
                    const badge = iconDiv.querySelector('.motion-badge');
                    if (badge) badge.innerText = motionIcon;
                    const batBar = iconDiv.querySelector('.battery-level');
                    if (batBar) {
                        batBar.style.width = `${batLevel}%`;
                        batBar.style.background = batColor;
                    }
                    const chargeIcon = iconDiv.querySelector('.charging-icon');
                    if (chargeIcon) chargeIcon.style.display = chargingDisplay;
                }
                user.marker.setPopupContent(name + ` (é›»é‡: ${batLevel}%)`);

                user.history.push([lat, lng]);
                if (user.history.length > 20) user.history.shift();
                user.polyline.setLatLngs(user.history);
            }
            updateUserListUI(); 
        }

        function updateMyLocation(lat, lng, motionStatus) {
            myHistory.push([lat, lng]);
            if (myHistory.length > 20) myHistory.shift();

            let batColor = '#00ff00';
            if (batteryLevel < 20) batColor = '#ff0000';
            else if (batteryLevel < 50) batColor = '#ffa500';
            const chargingDisplay = isCharging ? 'block' : 'none';

            if (!myMarker) {
                const icon = L.divIcon({
                    html: `
                    <div class="user-marker-container">
                        <div class="battery-bar-container"><div class="battery-level" style="width:${batteryLevel}%; background:${batColor};"></div></div>
                        <div class="charging-icon" style="display:${chargingDisplay}">âš¡</div>
                        <div class="vision-cone"></div>
                        <div class="user-avatar" style="background-image:url('${myProfile.pictureUrl || 'https://via.placeholder.com/40'}');"></div>
                        <div class="motion-badge">${motionStatus}</div>
                    </div>`,
                    className: '', iconSize: [40, 40], iconAnchor: [20, 20]
                });
                myMarker = L.marker([lat, lng], {icon: icon}).addTo(map).bindPopup("æˆ‘");
                myPolyline = L.polyline([], {color: '#06c755', weight: 3, opacity: 0.5, dashArray: '5, 10'}).addTo(map);
                map.panTo([lat, lng]);
            } else {
                myMarker.setLatLng([lat, lng]);
                const myIconDiv = myMarker.getElement();
                if (myIconDiv) {
                    const badge = myIconDiv.querySelector('.motion-badge');
                    if (badge) badge.innerText = motionStatus;
                    const batBar = myIconDiv.querySelector('.battery-level');
                    if (batBar) {
                        batBar.style.width = `${batteryLevel}%`;
                        batBar.style.background = batColor;
                    }
                    const chargeIcon = myIconDiv.querySelector('.charging-icon');
                    if (chargeIcon) chargeIcon.style.display = chargingDisplay;
                }
                if (myPolyline) myPolyline.setLatLngs(myHistory);
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'location', lat: lat, lng: lng, name: myProfile.name, avatar: myProfile.pictureUrl, 
                    motion: motionStatus, battery: batteryLevel, charging: isCharging
                }));
            }
            // è‡ªå·±ç§»å‹•æ™‚ä¹Ÿè¦æ›´æ–°æ¸…å–®ç‹€æ…‹
            updateUserListUI();
        }
        
        function enableSensors() {
            if (sensorsEnabled) return;
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') activateSensors();
                        else alert("éœ€è¦æ¬Šé™æ‰èƒ½ä½¿ç”¨ç¾…ç›¤èˆ‡æ–ä¸€æ–åŠŸèƒ½");
                    })
                    .catch(console.error);
            } else {
                activateSensors();
            }
        }
        function activateSensors() {
            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('devicemotion', handleMotion);
            sensorsEnabled = true;
            document.getElementById('btnSensors').classList.add('active');
            const cone = document.querySelector('.vision-cone');
            if (cone) cone.style.display = 'block';
            showSystemMsg("ç¾…ç›¤èˆ‡æ–ä¸€æ–åµæ¸¬å·²å•Ÿå‹•ï¼");
        }
        function handleOrientation(event) {
            let heading = 0;
            if (event.webkitCompassHeading) heading = event.webkitCompassHeading;
            else if (event.alpha) heading = 360 - event.alpha;
            const cone = document.querySelector('.vision-cone');
            if (cone) cone.style.transform = `translateX(-50%) rotate(${heading}deg)`;
        }
        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;
            const strength = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
            if (strength > 25) {
                const now = Date.now();
                if (now - lastShakeTime > 2000) {
                    lastShakeTime = now;
                    sendPing();
                }
            }
        }
        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping', name: myProfile.name }));
                if (navigator.vibrate) navigator.vibrate(200);
                showSystemMsg("ğŸ“³ å·²ç™¼é€å¼·åŠ›å‘¼å–šï¼");
            }
        }
        function beep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            osc.type = 'sine';
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 200);
        }
        function triggerShakeAlert(senderName) {
            showSystemMsg(`ğŸ“³ ${senderName} æ­£åœ¨å¤§åŠ›æ–æ‰‹æ©Ÿå‘¼å–šå¤§å®¶ï¼`);
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            try { beep(); setTimeout(beep, 300); } catch(e){}
            document.body.classList.add('shake-alert');
            setTimeout(() => document.body.classList.remove('shake-alert'), 1500);
        }
        function calculateGroupCenter() {
            let latSum = 0, lngSum = 0, count = 0;
            if (myLat !== null) { latSum += myLat; lngSum += myLng; count++; }
            for (const name in otherMarkers) {
                const user = otherMarkers[name];
                if ((Date.now() - user.lastUpdate) / 1000 < 60) {
                    const pos = user.marker.getLatLng();
                    latSum += pos.lat;
                    lngSum += pos.lng;
                    count++;
                }
            }
            if (count > 0) {
                const centerLat = latSum / count;
                const centerLng = lngSum / count;
                if (centerMarker) map.removeLayer(centerMarker);
                const starIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="font-size:35px; filter: drop-shadow(0 0 5px rgba(255,215,0,0.8));">â­</div>`,
                    iconSize: [35, 35], iconAnchor: [17, 20]
                });
                centerMarker = L.marker([centerLat, centerLng], {icon: starIcon}).addTo(map)
                    .bindPopup("<b>âš–ï¸ æ¨è–¦ä¸­å¿ƒé»</b><br>å¤§å®¶é›†åˆæœ€å…¬å¹³çš„ä½ç½®").openPopup();
                map.flyTo([centerLat, centerLng], 16);
                showSystemMsg(`å·²è¨ˆç®— ${count} äººçš„åœ°ç†ä¸­å¿ƒé»`);
            } else {
                showSystemMsg("ç„¡æ³•è¨ˆç®—ï¼šæ²’æœ‰è¶³å¤ çš„ä½ç½®è³‡è¨Š");
            }
        }
        async function requestWakeLock() {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') { await requestWakeLock(); }
        });
        function startStaleCheck() {
            if (staleCheckInterval) clearInterval(staleCheckInterval);
            staleCheckInterval = setInterval(() => {
                const now = Date.now();
                for (const name in otherMarkers) {
                    const user = otherMarkers[name];
                    if ((now - user.lastUpdate) / 1000 > 30) {
                        const iconDiv = user.marker.getElement();
                        if (iconDiv) iconDiv.classList.add('offline-marker');
                    }
                }
                updateUserListUI(); // æ›´æ–°åå–®é›¢ç·šç‹€æ…‹
            }, 5000);
        }
        function startTracking() {
            if (!navigator.geolocation) return;
            navigator.geolocation.watchPosition(
                (pos) => {
                    myLat = pos.coords.latitude;
                    myLng = pos.coords.longitude;
                    const speedMps = pos.coords.speed || 0;
                    const speedKmh = speedMps * 3.6;
                    let motionStatus = 'ğŸš¶';
                    if (speedKmh > 40) motionStatus = 'ğŸš—';
                    else if (speedKmh > 15) motionStatus = 'ğŸ›µ';
                    else if (speedKmh > 5) motionStatus = 'ğŸƒ';

                    updateMyLocation(myLat, myLng, motionStatus);
                    checkGeofence(); 
                },
                err => console.error(err),
                { enableHighAccuracy: true }
            );
        }
        function centerMapOnMe() {
            if (myLat && myLng) map.flyTo([myLat, myLng], 17);
            else showSystemMsg("å°šæœªå–å¾—æ‚¨çš„ä½ç½®");
        }
        function toggleFlagMode() {
            isFlagMode = !isFlagMode;
            const btn = document.getElementById('btnFlag');
            if (isFlagMode) {
                btn.innerText = "ğŸ“ è«‹é»æ“Šåœ°åœ–";
                btn.style.backgroundColor = "#dc3545";
                showSystemMsg("è«‹é»æ“Šåœ°åœ–è¨­å®šé›†åˆé»");
            } else {
                btn.innerText = "ğŸš© è¨­å®šé›†åˆé»";
                btn.style.backgroundColor = "#ff9800";
            }
        }
        map.on('click', function(e) {
            if (isFlagMode && ws) {
                ws.send(JSON.stringify({ type: 'flag', lat: e.latlng.lat, lng: e.latlng.lng, setter: myProfile.name }));
                toggleFlagMode();
            }
        });
        function updateFlag(lat, lng, setterName) {
            if (flagMarker) map.removeLayer(flagMarker);
            const flagIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="font-size:30px;">ğŸ</div>`,
                iconSize: [30, 30], iconAnchor: [15, 30]
            });
            flagMarker = L.marker([lat, lng], {icon: flagIcon}).addTo(map)
                .bindPopup(`<b>é›†åˆé»</b><br>ç”± ${setterName} è¨­å®š`).openPopup();
            showSystemMsg(`${setterName} æ›´æ–°äº†é›†åˆé»ï¼`);
            document.getElementById('distance-bar').style.display = 'block';
            hasArrived = false;
            document.getElementById('distance-bar').classList.remove('arrived');
            checkGeofence();
        }
        function checkGeofence() {
            if (!flagMarker || myLat === null) return;
            const from = L.latLng(myLat, myLng);
            const to = flagMarker.getLatLng();
            const meters = from.distanceTo(to);
            let text = meters < 30 ? "ğŸ‰ å·²æŠµé”é›†åˆé»ï¼" : meters < 1000 ? `${Math.round(meters)} å…¬å°º` : `${(meters/1000).toFixed(1)} å…¬é‡Œ`;
            document.getElementById('dist-val').innerText = text;

            if (meters < 30 && !hasArrived) {
                hasArrived = true;
                triggerCelebration();
                sendStatus('ğŸ‰ æˆ‘æŠµé”é›†åˆé»äº†ï¼');
                document.getElementById('distance-bar').classList.add('arrived');
            } else if (meters > 50) {
                hasArrived = false;
                document.getElementById('distance-bar').classList.remove('arrived');
            }
        }
        function triggerCelebration() {
            var duration = 3000;
            var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
            showSystemMsg("ğŸ‰ æ­å–œæŠµé”ï¼");
        }
        function sendStatus(msg) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'status', name: myProfile.name, msg: msg }));
                showStatusBubble(myProfile.name, msg); 
            }
        }
        function showStatusBubble(name, msg) {
            let targetMarker = (name === myProfile.name) ? myMarker : (otherMarkers[name] ? otherMarkers[name].marker : null);
            if (targetMarker) {
                targetMarker.bindTooltip(msg, { permanent: true, direction: 'top', className: 'status-bubble', offset: [0, -20] }).openTooltip();
                setTimeout(() => { targetMarker.unbindTooltip(); }, 5000);
            }
        }
        function shareToFriends() {
            const currentRoom = document.getElementById('roomId').value;
            const url = `https://liff.line.me/${LIFF_ID}?room=${currentRoom}`;
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([{
                    type: "flex", altText: "åŠ å…¥åœ°åœ–",
                    contents: { type: "bubble", body: { type: "box", layout: "vertical", contents: [
                        { type: "text", text: "ğŸ“ é»æ­¤åŠ å…¥å³æ™‚åœ°åœ–", weight: "bold", size: "lg", color: "#06c755" },
                        { type: "text", text: `æˆ¿è™Ÿ: ${currentRoom}`, size: "sm", color: "#666666", margin: "sm" },
                        { type: "text", text: "æŸ¥çœ‹å¤§å®¶çš„ä½ç½®èˆ‡é›†åˆé»", size: "xs", color: "#aaaaaa" }
                    ] }, footer: { type: "box", layout: "vertical", contents: [{ type: "button", action: { type: "uri", label: "é–‹å•Ÿåœ°åœ–", uri: url } }] } }
                }]);
            } else {
                navigator.clipboard.writeText(url).then(() => alert("ç¶²å€å·²è¤‡è£½"));
            }
        }
        function disconnect() { if(ws) ws.close(); location.reload(); }
        function scheduleReconnect() { if(reconnectTimeout) clearTimeout(reconnectTimeout); reconnectTimeout = setTimeout(connect, 3000); }
        function startHeartbeat() { if(heartbeatInterval) clearInterval(heartbeatInterval); heartbeatInterval = setInterval(() => { if(ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({type:'ping'})); }, 30000); }
        function updateStatus(msg) { document.getElementById('status-text').innerText = msg; }
        function showSystemMsg(msg) { const el = document.getElementById('system-msg'); el.innerText = msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 3000); }
    </script>
</body>
</html>