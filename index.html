<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket åœ°åœ–åˆ†äº«æ¸¬è©¦</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .control-panel { border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .input-group { margin-bottom: 10px; }
        label { display: inline-block; width: 80px; font-weight: bold; }
        input { padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:disabled { background-color: #ccc; }
        button.disconnect { background-color: #dc3545; }
        #log { background: #f4f4f4; border: 1px solid #ddd; height: 300px; overflow-y: scroll; padding: 10px; font-family: monospace; white-space: pre-wrap; }
        .received { color: green; }
        .sent { color: blue; }
        .status { color: gray; font-style: italic; }
    </style>
</head>
<body>

    <h2>ğŸ“ WebSocket å³æ™‚ä½ç½®æ¸¬è©¦</h2>

    <div class="control-panel">
        <div class="input-group">
            <label>Room ID:</label>
            <input type="text" id="roomId" value="room1">
        </div>
        <div class="input-group">
            <label>æ‚¨çš„åå­—:</label>
            <input type="text" id="userName" value="UserA">
        </div>
        
        <button id="btnConnect" onclick="connect()">é€£ç·š</button>
        <button id="btnDisconnect" onclick="disconnect()" disabled class="disconnect">æ–·ç·š</button>
    </div>

    <div class="control-panel">
        <h3>æ¨¡æ“¬ç™¼é€ä½ç½®</h3>
        <p>é»æ“ŠæŒ‰éˆ•æ¨¡æ“¬å‚³é€åº§æ¨™çµ¦ä¼ºæœå™¨ï¼š</p>
        <button id="btnSend" onclick="sendLocation()" disabled>ğŸ“ ç™¼é€éš¨æ©Ÿåº§æ¨™</button>
    </div>

    <h3>è¨Šæ¯ç´€éŒ„ï¼š</h3>
    <div id="log"></div>

    <script>
        let ws = null;

        function log(msg, type = 'status') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        }

        function connect() {
            const roomId = document.getElementById('roomId').value;
            const name = document.getElementById('userName').value;

            if (!roomId) { alert("è«‹è¼¸å…¥ Room ID"); return; }

            // é€£ç·šåˆ°ä½ çš„ FastAPI (é è¨­ port 8000)
            const wsUrl = `ws://localhost:8000/ws/${roomId}`;
            
            log(`æ­£åœ¨é€£ç·šåˆ° ${wsUrl} ...`);

            ws = new WebSocket(wsUrl);

            ws.onopen = function(event) {
                log("é€£ç·šæˆåŠŸï¼", "status");
                toggleButtons(true);
            };

            ws.onmessage = function(event) {
                // æ”¶åˆ°åˆ¥äººçš„ä½ç½®è³‡æ–™
                const data = JSON.parse(event.data);
                log(`æ”¶åˆ°ä¾†è‡ª ${data.name} çš„è³‡æ–™: lat=${data.lat}, lng=${data.lng}`, "received");
            };

            ws.onclose = function(event) {
                log("é€£ç·šå·²ä¸­æ–·", "status");
                toggleButtons(false);
                ws = null;
            };

            ws.onerror = function(error) {
                log("ç™¼ç”ŸéŒ¯èª¤", "status");
                console.error(error);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        function sendLocation() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("å°šæœªé€£ç·š");
                return;
            }

            const name = document.getElementById('userName').value;
            
            // æ¨¡æ“¬ä¸€å€‹éš¨æ©Ÿåº§æ¨™ (åœ¨å°åŒ—101é™„è¿‘)
            const baseLat = 25.0330;
            const baseLng = 121.5654;
            const randomLat = baseLat + (Math.random() - 0.5) * 0.01;
            const randomLng = baseLng + (Math.random() - 0.5) * 0.01;

            const payload = {
                lat: parseFloat(randomLat.toFixed(6)),
                lng: parseFloat(randomLng.toFixed(6)),
                name: name,
                avatar: "https://via.placeholder.com/50" // å‡é ­è²¼
            };

            ws.send(JSON.stringify(payload));
            log(`å·²ç™¼é€åº§æ¨™: ${payload.lat}, ${payload.lng}`, "sent");
        }

        function toggleButtons(isConnected) {
            document.getElementById('btnConnect').disabled = isConnected;
            document.getElementById('roomId').disabled = isConnected;
            document.getElementById('userName').disabled = isConnected;
            document.getElementById('btnDisconnect').disabled = !isConnected;
            document.getElementById('btnSend').disabled = !isConnected;
        }
    </script>
</body>
</html>